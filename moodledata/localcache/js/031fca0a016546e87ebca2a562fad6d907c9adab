M.form=M.form||{};if(typeof M.form.dependencyManager==='undefined'){var dependencyManager=function(){dependencyManager.superclass.constructor.apply(this,arguments)};Y.extend(dependencyManager,Y.Base,{_locks:null,_hides:null,_dirty:null,_nameCollections:null,_fileinputs:null,initializer:function(){this._locks={};this._hides={};this._dirty={};Y.Object.each(this.get('dependencies'),function(value,i){var elements=this.elementsByName(i);elements.each(function(node){var nodeName=node.get('nodeName').toUpperCase();if(nodeName=='INPUT'){if(node.getAttribute('type').match(/^(button|submit|radio|checkbox)$/)){node.on('click',this.updateEventDependencies,this)}else node.on('blur',this.updateEventDependencies,this);node.on('change',this.updateEventDependencies,this)}else if(nodeName=='SELECT'){node.on('change',this.updateEventDependencies,this)}else{node.on('click',this.updateEventDependencies,this);node.on('blur',this.updateEventDependencies,this);node.on('change',this.updateEventDependencies,this)}},this)},this);this.get('form').get('elements').each(function(input){if(input.getAttribute('type')=='reset')input.on('click',function(){this.get('form').reset();this.updateAllDependencies()},this)},this);this.updateAllDependencies()},initElementsByName:function(){var names={};Y.Object.each(this.get('dependencies'),function(conditions,i){names[i]=new Y.NodeList();for(var condition in conditions)for(var value in conditions[condition])for(var ei in conditions[condition][value])names[conditions[condition][value][ei]]=new Y.NodeList()});this.get('form').get('elements').each(function(node){var name=node.getAttribute('name');if({}.hasOwnProperty.call(names,name))names[name].push(node)});this._nameCollections=names},elementsByName:function(name){if(!this._nameCollections)this.initElementsByName();if(!{}.hasOwnProperty.call(this._nameCollections,name))return new Y.NodeList();return this._nameCollections[name]},checkDependencies:function(e,dependon){var dependencies=this.get('dependencies'),tohide={},tolock={},condition,value,lock,hide,checkfunction,result,elements;if(!{}.hasOwnProperty.call(dependencies,dependon))return true;elements=this.elementsByName(dependon);for(condition in dependencies[dependon])for(value in dependencies[dependon][condition]){checkfunction='_dependency'+condition[0].toUpperCase()+condition.slice(1);if(Y.Lang.isFunction(this[checkfunction])){result=this[checkfunction].apply(this,[elements,value,e])}else result=this._dependencyDefault(elements,value,e);lock=result.lock||false;hide=result.hide||false;for(var ei in dependencies[dependon][condition][value]){var eltolock=dependencies[dependon][condition][value][ei];if({}.hasOwnProperty.call(tohide,eltolock)){tohide[eltolock]=tohide[eltolock]||hide}else tohide[eltolock]=hide;if({}.hasOwnProperty.call(tolock,eltolock)){tolock[eltolock]=tolock[eltolock]||lock}else tolock[eltolock]=lock}};for(var el in tolock){var needsupdate=false;if(!{}.hasOwnProperty.call(this._locks,el))this._locks[el]={};if({}.hasOwnProperty.call(tolock,el)&&tolock[el]){if(!{}.hasOwnProperty.call(this._locks[el],dependon)||this._locks[el][dependon]){this._locks[el][dependon]=true;needsupdate=true}}else if({}.hasOwnProperty.call(this._locks[el],dependon)&&this._locks[el][dependon]){delete this._locks[el][dependon];needsupdate=true};if(!{}.hasOwnProperty.call(this._hides,el))this._hides[el]={};if({}.hasOwnProperty.call(tohide,el)&&tohide[el]){if(!{}.hasOwnProperty.call(this._hides[el],dependon)||this._hides[el][dependon]){this._hides[el][dependon]=true;needsupdate=true}}else if({}.hasOwnProperty.call(this._hides[el],dependon)&&this._hides[el][dependon]){delete this._hides[el][dependon];needsupdate=true};if(needsupdate)this._dirty[el]=true};return true},updateAllDependencies:function(){Y.Object.each(this.get('dependencies'),function(value,name){this.checkDependencies(null,name)},this);this.updateForm()},updateEventDependencies:function(e){var el=e.target.getAttribute('name');this.checkDependencies(e,el);this.updateForm()},updateForm:function(){var el;for(el in this._dirty){if({}.hasOwnProperty.call(this._locks,el))this._disableElement(el,!Y.Object.isEmpty(this._locks[el]));if({}.hasOwnProperty.call(this._hides,el))this._hideElement(el,!Y.Object.isEmpty(this._hides[el]))};this._dirty={}},_disableElement:function(name,disabled){var els=this.elementsByName(name),filepicker=this.isFilePicker(name);els.each(function(node){if(disabled){node.setAttribute('disabled','disabled')}else node.removeAttribute('disabled');if(filepicker){var fitem=node.ancestor('.fitem');if(fitem)if(disabled){fitem.addClass('disabled')}else fitem.removeClass('disabled')}})},_hideElement:function(name,hidden){var els=this.elementsByName(name);els.each(function(node){var e=node.ancestor('.fitem');if(e)e.setStyles({display:hidden?'none':''})})},isFilePicker:function(el){if(!this._fileinputs){var fileinputs={},els=this.get('form').all('.fitem.fitem_ffilepicker input,.fitem.fitem_ffilemanager input');els.each(function(node){fileinputs[node.getAttribute('name')]=true});this._fileinputs=fileinputs};if({}.hasOwnProperty.call(this._fileinputs,el))return this._fileinputs[el]||false;return false},_dependencyNotchecked:function(elements,value){var lock=false;elements.each(function(){if(this.getAttribute('type').toLowerCase()=='hidden'&&!this.siblings('input[type=checkbox][name="'+this.get('name')+'"]').isEmpty())return;if(this.getAttribute('type').toLowerCase()=='radio'&&this.get('value')!=value)return;lock=lock||!Y.Node.getDOMNode(this).checked});return{lock:lock,hide:false}},_dependencyChecked:function(elements,value){var lock=false;elements.each(function(){if(this.getAttribute('type').toLowerCase()=='hidden'&&!this.siblings('input[type=checkbox][name="'+this.get('name')+'"]').isEmpty())return;if(this.getAttribute('type').toLowerCase()=='radio'&&this.get('value')!=value)return;lock=lock||Y.Node.getDOMNode(this).checked});return{lock:lock,hide:false}},_dependencyNoitemselected:function(elements,value){var lock=false;elements.each(function(){lock=lock||this.get('selectedIndex')==-1});return{lock:lock,hide:false}},_dependencyEq:function(elements,value){var lock=false,hiddenVal=false,options,v,selected,values;elements.each(function(){if(this.getAttribute('type').toLowerCase()=='radio'&&!Y.Node.getDOMNode(this).checked){return}else if(this.getAttribute('type').toLowerCase()=='hidden'&&!this.siblings('input[type=checkbox][name="'+this.get('name')+'"]').isEmpty()){hiddenVal=(this.get('value')==value);return}else if(this.getAttribute('type').toLowerCase()=='checkbox'&&!Y.Node.getDOMNode(this).checked){lock=lock||hiddenVal;return};if(this.getAttribute('class').toLowerCase()=='filepickerhidden'){var elementname=this.getAttribute('name');if(elementname&&M.form_filepicker.instances[elementname].fileadded){lock=false}else lock=true}else if(this.get('nodeName').toUpperCase()==='SELECT'&&this.get('multiple')===true){values=value.split('|');selected=[];options=this.get('options');options.each(function(){if(this.get('selected'))selected[selected.length]=this.get('value')});if(selected.length>0&&selected.length===values.length){for(var i in selected){v=selected[i];if(values.indexOf(v)>-1){lock=true}else{lock=false;return}}}else lock=false}else lock=lock||this.get('value')==value});return{lock:lock,hide:false}},_dependencyIn:function(elements,values){values=values.split('|');var lock=false,hiddenVal=false,options,v,selected,value;elements.each(function(){if(this.getAttribute('type').toLowerCase()=='radio'&&!Y.Node.getDOMNode(this).checked){return}else if(this.getAttribute('type').toLowerCase()=='hidden'&&!this.siblings('input[type=checkbox][name="'+this.get('name')+'"]').isEmpty()){hiddenVal=(values.indexOf(this.get('value'))>-1);return}else if(this.getAttribute('type').toLowerCase()=='checkbox'&&!Y.Node.getDOMNode(this).checked){lock=lock||hiddenVal;return};if(this.getAttribute('class').toLowerCase()=='filepickerhidden'){var elementname=this.getAttribute('name');if(elementname&&M.form_filepicker.instances[elementname].fileadded){lock=false}else lock=true}else if(this.get('nodeName').toUpperCase()==='SELECT'&&this.get('multiple')===true){selected=[];options=this.get('options');options.each(function(){if(this.get('selected'))selected[selected.length]=this.get('value')});if(selected.length>0&&selected.length===values.length){for(var i in selected){v=selected[i];if(values.indexOf(v)>-1){lock=true}else{lock=false;return}}}else lock=false}else{value=this.get('value');lock=lock||(values.indexOf(value)>-1)}});return{lock:lock,hide:false}},_dependencyHide:function(elements,value){return{lock:false,hide:true}},_dependencyDefault:function(elements,value,ev){var lock=false,hiddenVal=false,values;elements.each(function(){var selected;if(this.getAttribute('type').toLowerCase()=='radio'&&!Y.Node.getDOMNode(this).checked){return}else if(this.getAttribute('type').toLowerCase()=='hidden'&&!this.siblings('input[type=checkbox][name="'+this.get('name')+'"]').isEmpty()){hiddenVal=(this.get('value')!=value);return}else if(this.getAttribute('type').toLowerCase()=='checkbox'&&!Y.Node.getDOMNode(this).checked){lock=lock||hiddenVal;return};if(this.getAttribute('class').toLowerCase()=='filepickerhidden'){var elementname=this.getAttribute('name');if(elementname&&M.form_filepicker.instances[elementname].fileadded){lock=true}else lock=false}else if(this.get('nodeName').toUpperCase()==='SELECT'&&this.get('multiple')===true){values=value.split('|');selected=[];this.get('options').each(function(){if(this.get('selected'))selected[selected.length]=this.get('value')});if(selected.length>0&&selected.length===values.length){for(var i in selected)if(values.indexOf(selected[i])>-1){lock=false}else{lock=true;return}}else lock=true}else lock=lock||this.get('value')!=value});return{lock:lock,hide:false}}},{NAME:'mform-dependency-manager',ATTRS:{form:{setter:function(value){return Y.one('#'+value)},value:null},dependencies:{value:{}}}});M.form.dependencyManager=dependencyManager};M.form.dependencyManagers={};M.form.initFormDependencies=function(Y,formid,dependencies){if(!Y.Lang.isArray(dependencies)&&!Y.Lang.isObject(dependencies))return false;Y.Node.ATTRS.elements={getter:function(){return Y.all(new Y.Array(this._node.elements,0,true))}};M.form.dependencyManagers[formid]=new M.form.dependencyManager({form:formid,dependencies:dependencies});return M.form.dependencyManagers[formid]};M.form.updateFormState=function(formid){if(formid in M.form.dependencyManagers)M.form.dependencyManagers[formid].updateAllDependencies()}